var credentials = require('./test/credentials.json');
var express = require('express');
var AccessToken = require('twilio').jwt.AccessToken;

var app = new express();

if (credentials.authToken) {
  console.warn('WARNING: The "authToken" field is deprecated. Please use "signingKeySecret".');
}

if (credentials.instanceSid) {
  console.warn('WARNING: The "instanceSid" field is deprecated. Please use "serviceSid".');
}

function getToken() {
   let token = new AccessToken(credentials.accountSid, credentials.signingKeySid, credentials.signingKeySecret, {
    identity: 'some-hardcoded-identity',
    ttl: 3600
  });

  let grant = new AccessToken.IpMessagingGrant();
  grant.serviceSid = credentials.serviceSid;
  token.addGrant(grant);

  return token.toJwt();
}

app.get('/', function(req, res) {
  var token = getToken();
  var response = `
    <html><body>
      <script src="./twilsock-bundle.js"></script>
      <script>
         let token = "${token}";
         let twilsock = new Twilio.Twilsock.Client(token);
      </script>
   </body></html>
  `;

  res.send(response);
});

app.use(express.static(__dirname + '/build'));

app.listen(8080);